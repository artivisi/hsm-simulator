<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Share Distribution</title>
    <link rel="stylesheet" th:href="@{/css/output.css}">
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-12 max-w-5xl">
        <!-- Header -->
        <div class="mb-8">
            <a th:href="@{/hsm/ceremony/{id}(id=${ceremonyId})}" class="text-blue-400 hover:text-blue-300 inline-flex items-center mb-4">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Dashboard
            </a>
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">
                        Key Share Distribution
                    </h1>
                    <p class="text-slate-400">Ceremony completed - Distribute key shares to custodians</p>
                </div>
                <div class="text-right">
                    <span class="inline-flex items-center px-4 py-2 rounded-full bg-green-900/30 border border-green-700/50 text-green-300">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        Completed
                    </span>
                </div>
            </div>
        </div>

        <!-- Master Key Information -->
        <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 mb-6 shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4 text-slate-200">Master Key Information</h2>

            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-slate-400">Master Key ID</p>
                    <p class="text-lg font-mono text-white" th:text="${masterKey.masterKeyId}">MK-2025-001</p>
                </div>
                <div>
                    <p class="text-sm text-slate-400">Algorithm</p>
                    <p class="text-lg text-white" th:text="${masterKey.algorithm}">AES-256</p>
                </div>
                <div class="md:col-span-2">
                    <p class="text-sm text-slate-400">Fingerprint</p>
                    <p class="text-lg font-mono text-white" th:text="${masterKey.keyFingerprint}">A1B2:C3D4:E5F6:7890</p>
                </div>
                <div>
                    <p class="text-sm text-slate-400">Generated At</p>
                    <p class="text-lg text-white" th:text="${#temporals.format(masterKey.generatedAt, 'MMM dd, yyyy HH:mm:ss')}">Oct 22, 2025 16:30:45</p>
                </div>
                <div>
                    <p class="text-sm text-slate-400">Status</p>
                    <p class="text-lg text-green-400 font-semibold" th:text="${masterKey.status}">ACTIVE</p>
                </div>
            </div>
        </div>

        <!-- Distribution Progress -->
        <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 mb-6 shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4 text-slate-200">Distribution Progress</h2>

            <div class="flex items-center justify-between p-4 bg-slate-900/30 rounded-lg">
                <div>
                    <p class="text-sm text-slate-400">Shares Distributed</p>
                    <p class="text-2xl font-bold" th:text="${distributedShares} + ' of ' + ${totalShares}">0 of 3</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-slate-400">Threshold</p>
                    <p class="text-lg text-white">2 shares required for recovery</p>
                </div>
            </div>
        </div>

        <!-- Custodian Key Shares -->
        <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 mb-6 shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4 text-slate-200">Custodian Key Shares</h2>

            <div class="space-y-4">
                <div th:each="share : ${shares}"
                     class="bg-slate-900/30 border rounded-xl p-6"
                     th:classappend="${share.distributed} ? 'border-green-700/50' : 'border-slate-700'">

                    <!-- Custodian Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div th:if="${share.distributed}"
                                 class="w-10 h-10 bg-green-900/30 border border-green-700/50 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div th:unless="${share.distributed}"
                                 class="w-10 h-10 bg-slate-700 border border-slate-600 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-white text-lg">
                                    <span th:text="${share.custodianLabel}">Custodian A</span>
                                    <span class="text-slate-400">-</span>
                                    <span th:text="${share.custodianName}">Alice Johnson</span>
                                </h3>
                                <p class="text-sm text-slate-400" th:text="${share.custodianEmail}">alice@example.com</p>
                            </div>
                        </div>
                        <div>
                            <span th:if="${share.distributed}"
                                  class="px-3 py-1 rounded-full bg-green-900/30 border border-green-700/50 text-green-300 text-sm">
                                Distributed
                            </span>
                            <span th:unless="${share.distributed}"
                                  class="px-3 py-1 rounded-full bg-yellow-900/30 border border-yellow-700/50 text-yellow-300 text-sm">
                                Pending
                            </span>
                        </div>
                    </div>

                    <!-- Share Details -->
                    <div class="grid md:grid-cols-2 gap-3 mb-4 text-sm">
                        <div>
                            <p class="text-slate-400">Share ID:</p>
                            <p class="font-mono text-slate-300" th:text="${share.shareId}">KS-2025-001-A</p>
                        </div>
                        <div>
                            <p class="text-slate-400">Share Index:</p>
                            <p class="text-slate-300"><span th:text="${share.shareIndex}">1</span> of <span th:text="${totalShares}">3</span></p>
                        </div>
                        <div>
                            <p class="text-slate-400">Verification Hash:</p>
                            <p class="font-mono text-slate-300 text-xs" th:text="${#strings.substring(share.verificationHash, 0, 16)} + '...'">a1b2c3d4e5f6...</p>
                        </div>
                        <div th:if="${share.distributedAt}">
                            <p class="text-slate-400">Distributed At:</p>
                            <p class="text-slate-300" th:text="${#temporals.format(share.distributedAt, 'MMM dd, HH:mm')}">Oct 22, 16:45</p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-wrap gap-2">
                        <button th:attr="data-share-id=${share.shareId}" onclick="downloadShare(this)"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-colors">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download Share
                        </button>

                        <button th:attr="data-share-id=${share.shareId},data-email=${share.custodianEmail}"
                                onclick="sendEmail(this)"
                                th:disabled="${share.distributed}"
                                th:classappend="${share.distributed} ? 'bg-slate-700 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700'"
                                class="px-4 py-2 text-white text-sm rounded-lg transition-colors">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Send via Email
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="bg-yellow-900/20 border border-yellow-700/50 rounded-2xl p-6">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-yellow-500 mr-3 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                    <h3 class="text-xl font-semibold text-yellow-300 mb-2">Security Notice</h3>
                    <ul class="space-y-1 text-yellow-100 text-sm">
                        <li>• Shares are encrypted and must be stored securely by custodians</li>
                        <li>• Any 2 shares can reconstruct the master key</li>
                        <li>• Distribute via secure channels only</li>
                        <li>• Confirm custodian receipt of shares</li>
                        <li>• Do not store all shares in the same location</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function downloadShare(button) {
            const shareId = button.getAttribute('data-share-id');

            try {
                const response = await fetch(`/api/shares/${shareId}/download`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `key-share-${shareId}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    // Show success message
                    showMessage('Share downloaded successfully', 'success');
                } else {
                    showMessage('Failed to download share', 'error');
                }
            } catch (error) {
                console.error('Error downloading share:', error);
                showMessage('An error occurred while downloading', 'error');
            }
        }

        async function sendEmail(button) {
            if (button.disabled) return;

            const shareId = button.getAttribute('data-share-id');
            const email = button.getAttribute('data-email');

            if (!confirm(`Send key share to ${email}?`)) {
                return;
            }

            button.disabled = true;
            const originalText = button.innerHTML;
            button.innerHTML = '<svg class="w-4 h-4 inline animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...';

            try {
                const response = await fetch(`/api/shares/${shareId}/email`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Share sent to ${email} successfully`, 'success');
                    // Reload page to update status
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage('Failed to send email: ' + result.error, 'error');
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showMessage('An error occurred while sending email', 'error');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function showMessage(message, type) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            } text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
